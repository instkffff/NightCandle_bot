'use strict';

var _getIterator2 = require('babel-runtime/core-js/get-iterator');

var _getIterator3 = _interopRequireDefault(_getIterator2);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var Promise = require('bluebird');

function splitIds(ids) {
  var groups = [];

  for (var i = 0; i < ids.length; i += 500) {
    var end = i + 500;
    if (end > ids.length) {
      end = ids.length;
    }
    groups.push(ids.slice(i, end));
  }

  return groups;
}

function getFilteredNames(api, ids, category) {
  return api.noAuth.post('/v2/universe/names/', { body: ids }).then(function (result) {
    if (category != 'all') {
      // Filter by category and remove the category field
      return result.filter(function (r) {
        return r.category == category;
      }).map(function (r) {
        return {
          id: r.id,
          name: r.name
        };
      });
    } else {
      return result;
    }
  });
}

/**
 * Internal utility function to query names of a given set of `ids`. Although
 * the ESI end point allows returning mixed types, this returns names
 * corresponding to only a single type specified by `category`. This makes an
 * HTTP POST request to
 * [`/universe/names/`](https://esi.tech.ccp.is/latest/#!/Universe/post_universe_names).
 *
 * The request is returned as an asynchronous Promise that resolves to an
 * object
 * parsed from the response JSON model. An example value looks like:
 *
 * ```
 * [
 *   {
 *     "id": 95465499,
 *     "name": "CCP Bartender"
 *   },
 *   {
 *     "id": 30000142,
 *     "name": "Jita"
 *   }
 * ]
 * ```
 *
 * `category` must be one of:
 *
 * # `'character'`
 * # `'corporation'`
 * # `'alliance'`
 * # `'station'`
 * # `'solar_system'`
 * # `'constellation'`
 * # `'region'`
 * # `'type'`
 * # `'all'` to disable category filtering (in which case `category` is
 * included` in each result element
 *
 * @param api {ESIAgent} Internal api
 * @param category {String} Category to filter names to
 * @param ids {Array.<Number>} Ids to look up
 * @returns {Promise}
 * @private
 */
module.exports = function (api, category, ids) {
  var groups = splitIds(ids);
  return Promise.map(groups, function (idSet) {
    return getFilteredNames(api, idSet, category);
  }).then(function (nameSets) {
    // Join each group of names into a single array
    var combined = [];
    var _iteratorNormalCompletion = true;
    var _didIteratorError = false;
    var _iteratorError = undefined;

    try {
      for (var _iterator = (0, _getIterator3.default)(nameSets), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
        var set = _step.value;

        combined = combined.concat(set);
      }
    } catch (err) {
      _didIteratorError = true;
      _iteratorError = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion && _iterator.return) {
          _iterator.return();
        }
      } finally {
        if (_didIteratorError) {
          throw _iteratorError;
        }
      }
    }

    return combined;
  });
};